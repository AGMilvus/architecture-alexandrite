# Мотивация
Уже сейчас компания сталкивается с ухудшением клиентского и пользовательского опыта, вызванного ростом нагрузки, снижением отзавчивости и задержками в исполнении заказов. Отсутсвие трейсинга не позволяет оперативно выявлять, локализовывать и утранять проблемы. Ситуация имеет тенденцию к усугублению. Как итог компания теряет клиентов и деньги.
Трейсинг позволяет отслеживать каждый этап обработки запроса, от первого контакта до последнего компонента системы. Это помогает:
- Быстро обнаружить узкие места и проблемы производительности, такие как медленные сервисы, проблемы с сетями или базами данных.
- Выявить ошибки в сложных цепочках взаимодействий между микросервисами.
- Проанализировать причину сбоя или ошибки, если какой-то компонент не работает должным образом.
- Определить компоненты, которые требуют оптимизации. 
- Узнать, где возникают задержки в процессе обработки запросов.
- Анализ взаимодействия между компонентами системы, что позволяет выявить ненужные или избыточные шаги, которые можно сократить или улучшить.

## Метрики
- Среднее время нахождения заказа в каждом из статусов:
    - `INITIATED` [онлайн-магазин] — пользователь завёл новый заказ или положил товары в пустую корзину.
    - `FILE_UPLOADED` [онлайн-магазин] — пользователь загрузил файл с 3D-моделью или создал его с помощью конструктора.
    - `SUBMITTED` [онлайн-магазин] — пользователь нажал на кнопку «Сделать заказ».
    - `PRICE_CALCULATED` [MES] — система посчитала стоимость заказа.
    - `MANUFACTURING_APPROVED` [CRM] — заказ подтверждён, его можно отдавать в производство.
    - `MANUFACTURING_STARTED` [MES] — оператор взял заказ в работу.
    - `MANUFACTURING_COMPLETED` [MES] — оператор выполнил заказ.
    - `PACKAGING` [MES] — оператор начал упаковывать заказ.
    - `SHIPPED` [MES] — заказ отправлен покупателю.
    - `CLOSED` [CRM] — заказ завершён. Он закрывается после получения.
- 95й перцентиль времени нахождения заказа в каждом из статусов.
- Количество неуспешных заказов по причине таймаутов или ошибок API
- Задержка обработки в очереди
- *dead-letter* очередей

# Предлагаемое решение
- Необходимо формализовать машину состояний для статусов заказа.
- Развернуть Jaeger
- Внедрить в код сервисов OpenTelemetry sdk для отправки данных трассировки:
    - `OpenTelemetry` `OpenTelemetry.Exporter.OpenTelemetryProtocol` для приложения C#, а так же `Npgsql.OpenTelemetry` если потребуется более глубокий трейсинг взаимодействия с БД.
    - `micrometer-registry-otlp` и `micrometer-tracing-bridge-brave` для приложений на Java Spring
    - `Firehose Tracer` для RabbitMq
    - БД PostgreSQL нативно не поддерживает работу с OpenTelemetry, но при возникновении сотрой необходимости можно дополнительно развернуть расширения `pg_tracing`, `pganalyze` и `otel_exporter_otlp_endpoint`
- Настроить трассировку заказов

[jewerly_c4_model](https://drive.google.com/file/d/16Ed23RUl_HuG_7PGIJWMMgJu-McJg2Dq/view?usp=sharing)

# Компромиссы
- Может быть проблематичным, а иногда и невозможным внедрение OpenTelemetry sdk в проприетарные системы. При невозможности внедрения можно попытаться обернуть отдельные части системы в трассирующий прокси.
- Создание и интеграция полноценного трейсинга требуют значительных временных и ресурсных затрат, а также определённых навыков и может оказаться неоправданным для создания MVP.
- Трейсинг создаёт дополнительный объем телеметрии, что увеличивает нагрузку на сеть, хранение и обработку данных.
- Трейсинг повышает риск утечки чувствительной информации (например, персональных данных).

# Безопасность
- Необходимо закрыть доступ к портам и адресам Jaeger из внешний сети, доступ к Jaeger возможен только через UI.
- UI закрыть за сервером авторизации с доступом пользователей с ролью "Поддержка".